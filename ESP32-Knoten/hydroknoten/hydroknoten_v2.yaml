################################################################################
# DiXY RDWC – Hydroknoten v0.2-beta
# Funktion: EC/pH-Monitoring + Wasserstandskontrolle (6x) + Temperaturmessung
# Hardware: ESP32-DevKit + ADS1115 + DS18B20 (2x) + 6x D1CS-D
################################################################################

substitutions:
  device_name: hydroknoten_v2
  friendly_name: "Hydroknoten v2"
  project_name: "DiXY Hydroknoten v2"
  project_version: "0.1"

  # Pins
  i2c_sda_pin: "21"
  i2c_scl_pin: "22"
  onewire_pin1: "4"
  onewire_pin2: "5"
  tank1_pin: "32"
  tank2_pin: "33"
  tank3_pin: "14"
  tank4_pin: "12"
  tank5_pin: "13"
  tank6_pin: "15"
  status_led_pin: "2"

  # ADS1115
  ads1115_address: "0x48"

esphome:
  name: ${device_name}
  comment: "DiXY Hydroknoten v0.2-beta – EC/pH + Temps + 6x Wasserstand"
  project:
    name: "dixy.${project_name}"
    version: ${project_version}

esp32:
  board: esp32dev
  framework:
    type: arduino

logger:
  level: INFO

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password
  ap:
    ssid: "${friendly_name} Fallback"
    password: "dixy12345"

api:
  encryption:
    key: !secret api_encryption_key

ota:
  password: !secret ota_password

web_server:
  port: 80

time:
  - platform: sntp
    id: sntp_time

status_led:
  pin: ${status_led_pin}

i2c:
  sda: ${i2c_sda_pin}
  scl: ${i2c_scl_pin}
  scan: true
  frequency: 400kHz
  id: bus_main

ads1115:
  - id: ads1
    address: ${ads1115_address}
    i2c_id: bus_main

dallas:
  - id: ow_bus1
    pin: ${onewire_pin1}
  - id: ow_bus2
    pin: ${onewire_pin2}

globals:
  - id: last_ec_cal_ts
    type: uint32_t
    restore_value: true
    initial_value: '0'
  - id: last_ph_cal_ts
    type: uint32_t
    restore_value: true
    initial_value: '0'

sensor:
  # System
  - platform: wifi_signal
    name: "${friendly_name} WiFi Signal"
    id: wifi_dbm
    unit_of_measurement: "dBm"
    update_interval: 60s

  - platform: uptime
    name: "${friendly_name} Uptime"
    id: node_uptime
    unit_of_measurement: "h"
    update_interval: 60s
    filters:
      - lambda: return x / 3600.0;

  - platform: internal_temperature
    name: "${friendly_name} MCU Temp"
    update_interval: 30s

  - platform: template
    name: "${friendly_name} Free Heap"
    unit_of_measurement: "kB"
    update_interval: 60s
    lambda: |-
      return ESP.getFreeHeap() / 1024.0;

  # DS18B20 raw
  - platform: dallas
    name: "${friendly_name} Tank Temp Roh"
    id: temp1_raw
    dallas_id: ow_bus1
    index: 0
    update_interval: 15s

  - platform: dallas
    name: "${friendly_name} Ruecklauf Temp Roh"
    id: temp2_raw
    dallas_id: ow_bus2
    index: 0
    update_interval: 15s

  # DS18B20 corrected
  - platform: template
    name: "${friendly_name} Tank Temp"
    id: temp1_corr
    device_class: temperature
    unit_of_measurement: "°C"
    state_class: measurement
    update_interval: 15s
    lambda: |-
      if (!id(temp1_raw).has_state()) return NAN;
      return id(temp1_raw).state + id(temp1_offset).state;

  - platform: template
    name: "${friendly_name} Ruecklauf Temp"
    id: temp2_corr
    device_class: temperature
    unit_of_measurement: "°C"
    state_class: measurement
    update_interval: 15s
    lambda: |-
      if (!id(temp2_raw).has_state()) return NAN;
      return id(temp2_raw).state + id(temp2_offset).state;

  # ADS1115 raw
  - platform: ads1115
    ads1115_id: ads1
    multiplexer: A0_GND
    gain: 6.144
    name: "${friendly_name} EC Raw Voltage"
    id: ec_raw
    unit_of_measurement: "V"
    update_interval: 1s

  - platform: ads1115
    ads1115_id: ads1
    multiplexer: A1_GND
    gain: 6.144
    name: "${friendly_name} pH Raw Voltage"
    id: ph_raw
    unit_of_measurement: "V"
    update_interval: 1s

  # Derived EC (temp-compensated to 25C)
  - platform: template
    name: "${friendly_name} EC"
    id: ec_value
    unit_of_measurement: "mS/cm"
    accuracy_decimals: 2
    device_class: conductivity
    state_class: measurement
    update_interval: 10s
    lambda: |-
      if (!id(ec_raw).has_state()) return NAN;
      float v = id(ec_raw).state * 3.3;
      float v_low = id(ec_cal_low).state;
      float v_high = id(ec_cal_high).state;
      float slope = (12.88f - 1.413f) / (v_high - v_low);
      float offset = 1.413f - slope * v_low;
      float ec = slope * v + offset;
      if (ec < 0) ec = 0;
      if (id(temp1_corr).has_state()) {
        float t = id(temp1_corr).state;
        ec = ec / (1 + 0.0185f * (t - 25.0f));
      }
      return ec;

  # Derived pH
  - platform: template
    name: "${friendly_name} pH"
    id: ph_value
    unit_of_measurement: "pH"
    accuracy_decimals: 2
    state_class: measurement
    update_interval: 10s
    lambda: |-
      if (!id(ph_raw).has_state()) return NAN;
      float v = id(ph_raw).state * 3.3;
      float v7 = id(ph_cal_7).state;
      float v4 = id(ph_cal_4).state;
      float m = (4.0f - 7.0f) / (v4 - v7);
      return m * (v - v7) + 7.0f;

  # Health: ADS + temps
  - platform: template
    name: "${friendly_name} ADS1115 OK"
    id: ads1115_ok
    device_class: problem
    lambda: |-
      return !(id(ec_raw).has_state() && id(ph_raw).has_state());
    filters:
      - delayed_on: 2s
      - delayed_off: 5s

  - platform: template
    name: "${friendly_name} Temp Sensoren OK"
    id: temps_ok
    device_class: problem
    lambda: |-
      return !(id(temp1_raw).has_state() && id(temp2_raw).has_state());
    filters:
      - delayed_on: 5s
      - delayed_off: 5s

binary_sensor:
  - platform: status
    name: "${friendly_name} Status"

  # Water-level sensors (LOW = water present)
  - platform: gpio
    name: "${friendly_name} Tank 1 Level"
    id: tank1_level
    pin:
      number: ${tank1_pin}
      mode: INPUT_PULLUP
      inverted: true
    device_class: moisture
    filters:
      - delayed_on: 500ms
      - delayed_off: 2s

  - platform: gpio
    name: "${friendly_name} Tank 2 Level"
    id: tank2_level
    pin:
      number: ${tank2_pin}
      mode: INPUT_PULLUP
      inverted: true
    device_class: moisture
    filters:
      - delayed_on: 500ms
      - delayed_off: 2s

  - platform: gpio
    name: "${friendly_name} Tank 3 Level"
    id: tank3_level
    pin:
      number: ${tank3_pin}
      mode: INPUT_PULLUP
      inverted: true
    device_class: moisture
    filters:
      - delayed_on: 500ms
      - delayed_off: 2s

  - platform: gpio
    name: "${friendly_name} Tank 4 Level"
    id: tank4_level
    pin:
      number: ${tank4_pin}
      mode: INPUT_PULLUP
      inverted: true
    device_class: moisture
    filters:
      - delayed_on: 500ms
      - delayed_off: 2s

  - platform: gpio
    name: "${friendly_name} Tank 5 Level"
    id: tank5_level
    pin:
      number: ${tank5_pin}
      mode: INPUT_PULLUP
      inverted: true
    device_class: moisture
    filters:
      - delayed_on: 500ms
      - delayed_off: 2s

  - platform: gpio
    name: "${friendly_name} Tank 6 Level"
    id: tank6_level
    pin:
      number: ${tank6_pin}
      mode: INPUT_PULLUP
      inverted: true
    device_class: moisture
    filters:
      - delayed_on: 500ms
      - delayed_off: 2s

  - platform: template
    name: "${friendly_name} Tank Leer (irgendeiner)"
    id: any_tank_empty
    device_class: problem
    lambda: |-
      return !id(tank1_level).state || !id(tank2_level).state || !id(tank3_level).state ||
             !id(tank4_level).state || !id(tank5_level).state || !id(tank6_level).state;
    filters:
      - delayed_on: 1s
      - delayed_off: 5s

text_sensor:
  - platform: wifi_info
    ip_address:
      name: "${friendly_name} IP"
    ssid:
      name: "${friendly_name} WLAN"
    bssid:
      name: "${friendly_name} BSSID"
    mac_address:
      name: "${friendly_name} MAC"

  - platform: version
    name: "${friendly_name} ESPHome Version"

  - platform: template
    name: "${friendly_name} Projekt Version"
    lambda: |-
      return {std::string(${project_version})};
    update_interval: 300s

  - platform: template
    name: "${friendly_name} Status Summary"
    lambda: |-
      char buf[192];
      snprintf(buf, sizeof(buf),
        "EC %.2f mS/cm | pH %.2f | T1 %.1fC | T2 %.1fC | WiFi %d dBm",
        id(ec_value).state,
        id(ph_value).state,
        id(temp1_corr).state,
        id(temp2_corr).state,
        (int) id(wifi_dbm).state
      );
      return std::string(buf);
    update_interval: 30s

number:
  - platform: template
    name: "${friendly_name} Temp1 Offset"
    id: temp1_offset
    min_value: -2
    max_value: 2
    step: 0.1
    restore_value: true
    initial_value: 0

  - platform: template
    name: "${friendly_name} Temp2 Offset"
    id: temp2_offset
    min_value: -2
    max_value: 2
    step: 0.1
    restore_value: true
    initial_value: 0

  - platform: template
    name: "${friendly_name} EC Cal 1.413mS"
    id: ec_cal_low
    min_value: 0.05
    max_value: 1.0
    step: 0.001
    restore_value: true
    initial_value: 0.104

  - platform: template
    name: "${friendly_name} EC Cal 12.88mS"
    id: ec_cal_high
    min_value: 1.0
    max_value: 3.3
    step: 0.001
    restore_value: true
    initial_value: 1.598

  - platform: template
    name: "${friendly_name} pH Cal 7.0"
    id: ph_cal_7
    min_value: 1.0
    max_value: 4.0
    step: 0.01
    restore_value: true
    initial_value: 2.50

  - platform: template
    name: "${friendly_name} pH Cal 4.0"
    id: ph_cal_4
    min_value: 1.0
    max_value: 4.0
    step: 0.01
    restore_value: true
    initial_value: 3.00

button:
  - platform: restart
    name: "${friendly_name} Neustart"

  - platform: template
    name: "${friendly_name} EC Kalibrierung markieren"
    on_press:
      then:
        - lambda: |-
            auto t = id(sntp_time).now();
            if (t.is_valid()) id(last_ec_cal_ts) = t.timestamp;

  - platform: template
    name: "${friendly_name} pH Kalibrierung markieren"
    on_press:
      then:
        - lambda: |-
            auto t = id(sntp_time).now();
            if (t.is_valid()) id(last_ph_cal_ts) = t.timestamp;
