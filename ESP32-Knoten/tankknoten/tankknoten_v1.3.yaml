esphome:
  name: tankknoten
  comment: "Tankknoten: Haupttank + RDWC-Level (6 Stufen je Tank), manuelle Aktoren."
  project:
    name: "loserat.dixy_tankknoten"
    version: "1.4"
  on_boot:
    priority: -100.0
    then:
      - logger.log: "Tankknoten gestartet. Version 1.4"
esp32:
  board: esp32dev
  framework:
    type: arduino

logger:
  level: info
  

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password
  ap:
    ssid: "Tankknoten Fallback"
    password: "dixy12345"

api:
  encryption:
    key: !secret api_encryption_key

ota:
  platform: esphome
  password: !secret ota_password

web_server:
  port: 80

time:
  - platform: sntp
    id: ha_time
    timezone: "Europe/Berlin"

substitutions:
  main_fill_relay_pin: "4"
  rdwc_fill_relay_pin: "5"
  leak_guard_pin: "34"

binary_sensor:
  - platform: template
    name: "Haupttank Level 1"
    id: main_lvl_1
    lambda: |-
      return id(main_lvl_1_sim).state;
    on_release:
      - switch.turn_off: rdwc_fill_relay
      - lambda: |-
          auto now = id(ha_time).now();
          if (now.is_valid()) {
            id(main_last_low_ts) = now.timestamp;
          }
  - platform: template
    name: "Haupttank Level 2"
    id: main_lvl_2
    lambda: |-
      return id(main_lvl_2_sim).state;
  - platform: template
    name: "Haupttank Level 3"
    id: main_lvl_3
    lambda: |-
      return id(main_lvl_3_sim).state;
  - platform: template
    name: "Haupttank Level 4"
    id: main_lvl_4
    lambda: |-
      return id(main_lvl_4_sim).state;
  - platform: template
    name: "Haupttank Level 5"
    id: main_lvl_5
    lambda: |-
      return id(main_lvl_5_sim).state;
  - platform: template
    name: "Haupttank Level 6"
    id: main_lvl_6
    lambda: |-
      return id(main_lvl_6_sim).state;
    on_press:
      - switch.turn_off: main_fill_relay
      - lambda: |-
          auto now = id(ha_time).now();
          if (now.is_valid()) {
            id(main_last_full_ts) = now.timestamp;
          }

  - platform: template
    name: "RDWC Level 1"
    id: rdwc_lvl_1
    lambda: |-
      return id(rdwc_lvl_1_sim).state;
    on_release:
      - lambda: |-
          auto now = id(ha_time).now();
          if (now.is_valid()) {
            id(rdwc_last_low_ts) = now.timestamp;
          }
  - platform: template
    name: "RDWC Level 2"
    id: rdwc_lvl_2
    lambda: |-
      return id(rdwc_lvl_2_sim).state;
  - platform: template
    name: "RDWC Level 3"
    id: rdwc_lvl_3
    lambda: |-
      return id(rdwc_lvl_3_sim).state;
  - platform: template
    name: "RDWC Level 4"
    id: rdwc_lvl_4
    lambda: |-
      return id(rdwc_lvl_4_sim).state;
  - platform: template
    name: "RDWC Level 5"
    id: rdwc_lvl_5
    lambda: |-
      return id(rdwc_lvl_5_sim).state;
  - platform: template
    name: "RDWC Level 6"
    id: rdwc_lvl_6
    lambda: |-
      return id(rdwc_lvl_6_sim).state;
    on_press:
      - switch.turn_off: rdwc_fill_relay
      - lambda: |-
          auto now = id(ha_time).now();
          if (now.is_valid()) {
            id(rdwc_last_full_ts) = now.timestamp;
          }
  - platform: template
    name: "Leckage Kontakt"
    id: leak_contact
    device_class: moisture
    lambda: |-
      return id(leak_contact_sim).state;
    on_press:
      - switch.turn_off: main_fill_relay
      - switch.turn_off: rdwc_fill_relay
    on_release:
      - logger.log: "Leckage Kontakt frei"
  - platform: template
    name: "Notfall Wasserwächter"
    id: leak_guard
    device_class: safety
    lambda: |-
      return id(leak_contact).state;
  - platform: template
    name: "Haupttank Ventil Status"
    lambda: |-
      return id(main_fill_relay).state ? "geoeffnet" : "geschlossen";
  - platform: template
    name: "RDWC Pumpe Status"
    device_class: running
    lambda: |-
      return id(rdwc_fill_relay).state;

switch:
  - platform: gpio
    name: "Haupttank Befüllen"
    pin: ${main_fill_relay_pin}
    restore_mode: ALWAYS_OFF
    id: main_fill_relay
    on_turn_on:
      - if:
          condition:
            or:
              - binary_sensor.is_on: main_lvl_6
              - switch.is_on: main_lvl_6_sim
              - switch.is_on: emergency_stop
          then:
            - switch.turn_off: main_fill_relay
  - platform: gpio
    name: "RDWC Befüllen"
    pin: ${rdwc_fill_relay_pin}
    restore_mode: ALWAYS_OFF
    id: rdwc_fill_relay
    on_turn_on:
      - if:
          condition:
            or:
              - binary_sensor.is_on: rdwc_lvl_6
              - switch.is_on: rdwc_lvl_6_sim
              - switch.is_on: emergency_stop
          then:
            - switch.turn_off: rdwc_fill_relay

  - platform: template
    name: "Not-Aus Befüllung"
    id: emergency_stop
    restore_mode: RESTORE_DEFAULT_OFF
    optimistic: true
    icon: "mdi:alert-octagon"
    turn_on_action:
      - switch.turn_off: main_fill_relay
      - switch.turn_off: rdwc_fill_relay
    turn_off_action:
      - logger.log: "Not-Aus aufgehoben. Befuellautomatik System darf wieder schalten."
  - platform: template
    name: "Leckage Kontakt Eingang"
    id: leak_contact_sim
    restore_mode: RESTORE_DEFAULT_OFF
    optimistic: true
  - platform: template
    name: "RDWC Auto Befuellen"
    id: rdwc_auto_fill_enabled
    restore_mode: RESTORE_DEFAULT_OFF
    optimistic: true
    turn_off_action:
      - if:
          condition:
            lambda: 'return id(automation_phase) == 0;'
          then:
            - switch.turn_off: rdwc_fill_relay
  - platform: template
    name: "Haupttank Level 1 Eingang"
    id: main_lvl_1_sim
    restore_mode: RESTORE_DEFAULT_OFF
    optimistic: true
  - platform: template
    name: "Haupttank Level 2 Eingang"
    id: main_lvl_2_sim
    restore_mode: RESTORE_DEFAULT_OFF
    optimistic: true
  - platform: template
    name: "Haupttank Level 3 Eingang"
    id: main_lvl_3_sim
    restore_mode: RESTORE_DEFAULT_OFF
    optimistic: true
  - platform: template
    name: "Haupttank Level 4 Eingang"
    id: main_lvl_4_sim
    restore_mode: RESTORE_DEFAULT_OFF
    optimistic: true
  - platform: template
    name: "Haupttank Level 5 Eingang"
    id: main_lvl_5_sim
    restore_mode: RESTORE_DEFAULT_OFF
    optimistic: true
  - platform: template
    name: "Haupttank Level 6 Eingang"
    id: main_lvl_6_sim
    restore_mode: RESTORE_DEFAULT_OFF
    optimistic: true
    on_turn_on:
      - switch.turn_off: main_fill_relay
  - platform: template
    name: "RDWC Level 1 Eingang"
    id: rdwc_lvl_1_sim
    restore_mode: RESTORE_DEFAULT_OFF
    optimistic: true
  - platform: template
    name: "RDWC Level 2 Eingang"
    id: rdwc_lvl_2_sim
    restore_mode: RESTORE_DEFAULT_OFF
    optimistic: true
  - platform: template
    name: "RDWC Level 3 Eingang"
    id: rdwc_lvl_3_sim
    restore_mode: RESTORE_DEFAULT_OFF
    optimistic: true
  - platform: template
    name: "RDWC Level 4 Eingang"
    id: rdwc_lvl_4_sim
    restore_mode: RESTORE_DEFAULT_OFF
    optimistic: true
  - platform: template
    name: "RDWC Level 5 Eingang"
    id: rdwc_lvl_5_sim
    restore_mode: RESTORE_DEFAULT_OFF
    optimistic: true
  - platform: template
    name: "RDWC Level 6 Eingang"
    id: rdwc_lvl_6_sim
    restore_mode: RESTORE_DEFAULT_OFF
    optimistic: true
    on_turn_on:
      - switch.turn_off: rdwc_fill_relay
  - platform: template
    name: "EC Temperaturkompensation"
    id: ec_temp_comp_enabled
    restore_mode: RESTORE_DEFAULT_ON
    optimistic: true
button:
  - platform: template
    name: "Befuellautomatik System"
    id: befuell_automation_trigger
    on_press:
      - lambda: |-
          if (id(automation_phase) == 0) {
            id(automation_phase) = 1;
            id(automation_wait_start_ms) = 0;
            id(befuell_done_ms) = 0;
            id(befuell_last_result) = 0;
            id(befuell_rdwc_started) = false;
            id(befuell_main_sim_level) = 0;
            id(befuell_rdwc_sim_level) = 0;
            id(befuell_main_sim_last_ms) = 0;
            id(befuell_rdwc_sim_last_ms) = 0;
            int target = (int) id(befuell_main_target_level).state;
            if (target < 2) target = 2;
            if (target > 5) target = 5;
            bool reached = false;
            if (target <= 2) reached = id(main_lvl_2_sim).state;
            else if (target == 3) reached = id(main_lvl_3_sim).state;
            else if (target == 4) reached = id(main_lvl_4_sim).state;
            else reached = id(main_lvl_5_sim).state;
            id(befuell_skip_wait) = reached;
          }
      - if:
          condition:
            and:
              - lambda: 'return !(id(main_lvl_4).state || id(main_lvl_4_sim).state);'
              - switch.is_off: emergency_stop
              - binary_sensor.is_off: leak_contact
          then:
            - switch.turn_on: main_fill_relay
  - platform: template
    name: "Test Reset"
    id: test_reset
    on_press:
      - switch.turn_off: main_fill_relay
      - switch.turn_off: rdwc_fill_relay
      - switch.turn_off: emergency_stop
      - switch.turn_off: leak_contact_sim
      - switch.turn_off: main_lvl_1_sim
      - switch.turn_off: main_lvl_2_sim
      - switch.turn_off: main_lvl_3_sim
      - switch.turn_off: main_lvl_4_sim
      - switch.turn_off: main_lvl_5_sim
      - switch.turn_off: main_lvl_6_sim
      - switch.turn_off: rdwc_lvl_1_sim
      - switch.turn_off: rdwc_lvl_2_sim
      - switch.turn_off: rdwc_lvl_3_sim
      - switch.turn_off: rdwc_lvl_4_sim
      - switch.turn_off: rdwc_lvl_5_sim
      - switch.turn_off: rdwc_lvl_6_sim
      - lambda: |-
          id(automation_phase) = 0;
          id(automation_wait_start_ms) = 0;
          id(befuell_done_ms) = 0;
          id(befuell_last_result) = 0;
          id(befuell_rdwc_started) = false;
          id(befuell_skip_wait) = false;
          id(befuell_main_sim_level) = 0;
          id(befuell_rdwc_sim_level) = 0;
          id(befuell_main_sim_last_ms) = 0;
          id(befuell_rdwc_sim_last_ms) = 0;
          id(main_last_full_ts) = 0;
          id(main_last_low_ts) = 0;
          id(rdwc_last_full_ts) = 0;
          id(rdwc_last_low_ts) = 0;
  - platform: template
    name: "RDWC Reset"
    id: rdwc_reset
    on_press:
      - switch.turn_off: rdwc_lvl_1_sim
      - switch.turn_off: rdwc_lvl_2_sim
      - switch.turn_off: rdwc_lvl_3_sim
      - switch.turn_off: rdwc_lvl_4_sim
      - switch.turn_off: rdwc_lvl_5_sim
      - switch.turn_off: rdwc_lvl_6_sim
      - lambda: |-
          id(befuell_rdwc_started) = false;
          id(befuell_rdwc_sim_level) = 0;
          id(befuell_rdwc_sim_last_ms) = 0;

globals:
  - id: main_last_full_ts
    type: uint32_t
    restore_value: true
    initial_value: '0'
  - id: main_last_low_ts
    type: uint32_t
    restore_value: true
    initial_value: '0'
  - id: rdwc_last_full_ts
    type: uint32_t
    restore_value: true
    initial_value: '0'
  - id: rdwc_last_low_ts
    type: uint32_t
    restore_value: true
    initial_value: '0'
  - id: rdwc_auto_last_fill_ts
    type: uint32_t
    restore_value: true
    initial_value: '0'
  - id: rdwc_auto_done_ms
    type: uint32_t
    restore_value: false
    initial_value: '0'
  - id: rdwc_auto_active_filling
    type: bool
    restore_value: false
    initial_value: 'false'
  - id: automation_phase
    type: int
    restore_value: false
    initial_value: '0'
  - id: automation_wait_start_ms
    type: uint32_t
    restore_value: false
    initial_value: '0'
  - id: befuell_rdwc_started
    type: bool
    restore_value: false
    initial_value: 'false'
  - id: befuell_main_sim_level
    type: int
    restore_value: false
    initial_value: '0'
  - id: befuell_rdwc_sim_level
    type: int
    restore_value: false
    initial_value: '0'
  - id: befuell_main_sim_last_ms
    type: uint32_t
    restore_value: false
    initial_value: '0'
  - id: befuell_rdwc_sim_last_ms
    type: uint32_t
    restore_value: false
    initial_value: '0'
  - id: befuell_skip_wait
    type: bool
    restore_value: false
    initial_value: 'false'
  - id: befuell_last_result
    type: int
    restore_value: false
    initial_value: '0'
  - id: befuell_done_ms
    type: uint32_t
    restore_value: false
    initial_value: '0'

number:
  - platform: template
    name: "Haupttank Volumen"
    id: main_tank_volume_l
    unit_of_measurement: "L"
    optimistic: true
    min_value: 10
    max_value: 1000
    step: 10
    initial_value: 100
    restore_value: true

  - platform: template
    name: "RDWC Volumen"
    id: rdwc_tank_volume_l
    unit_of_measurement: "L"
    optimistic: true
    min_value: 10
    max_value: 1000
    step: 10
    initial_value: 80
    restore_value: true

  - platform: template
    name: "RDWC Auto Ziellevel"
    id: rdwc_auto_target_level
    optimistic: true
    min_value: 2
    max_value: 5
    step: 1
    initial_value: 4
    restore_value: true

  - platform: template
    name: "Tanktemperatur Offset"
    id: tank_temp_offset
    unit_of_measurement: "°C"
    optimistic: true
    min_value: -2.0
    max_value: 2.0
    step: 0.1
    initial_value: 0.0
    restore_value: true
  - platform: template
    name: "Befuellautomatik System Ziellevel Haupttank"
    id: befuell_main_target_level
    optimistic: true
    min_value: 2
    max_value: 5
    step: 1
    initial_value: 4
    restore_value: true
  - platform: template
    name: "Befuellautomatik System Ziellevel RDWC"
    id: befuell_rdwc_target_level
    optimistic: true
    min_value: 2
    max_value: 5
    step: 1
    initial_value: 4
    restore_value: true
  - platform: template
    name: "Befuellautomatik System Wartezeit (s)"
    id: befuell_automation_wait_seconds
    unit_of_measurement: "s"
    optimistic: true
    min_value: 10
    max_value: 60
    step: 10
    initial_value: 10
    restore_value: true

interval:
  - interval: 1s
    then:
      - if:
          condition:
            or:
              - binary_sensor.is_on: main_lvl_6
              - switch.is_on: main_lvl_6_sim
          then:
            - switch.turn_off: main_fill_relay
      - if:
          condition:
            or:
              - binary_sensor.is_on: rdwc_lvl_6
              - switch.is_on: rdwc_lvl_6_sim
          then:
            - switch.turn_off: rdwc_fill_relay
      - lambda: |-
          // Befuellautomatik System: Haupttank bis Ziellevel -> warten -> RDWC bis Ziellevel.
          if (id(emergency_stop).state || id(leak_contact).state) {
            id(main_fill_relay).turn_off();
            id(rdwc_fill_relay).turn_off();
            id(automation_phase) = 0;
            id(automation_wait_start_ms) = 0;
            id(befuell_done_ms) = 0;
            id(befuell_last_result) = 0;
            id(befuell_main_sim_last_ms) = 0;
            id(befuell_rdwc_sim_last_ms) = 0;
            return;
          }

          int main_target = (int) id(befuell_main_target_level).state;
          if (main_target < 2) main_target = 2;
          if (main_target > 5) main_target = 5;
          int rdwc_target = (int) id(befuell_rdwc_target_level).state;
          if (rdwc_target < 2) rdwc_target = 2;
          if (rdwc_target > 5) rdwc_target = 5;
          int rdwc_auto_target = (int) id(rdwc_auto_target_level).state;
          if (rdwc_auto_target < 2) rdwc_auto_target = 2;
          if (rdwc_auto_target > 5) rdwc_auto_target = 5;

          auto level_reached = [&](int target, bool is_main) -> bool {
            if (is_main) {
              if (target <= 2) return id(main_lvl_2_sim).state;
              if (target == 3) return id(main_lvl_3_sim).state;
              if (target == 4) return id(main_lvl_4_sim).state;
              return id(main_lvl_5_sim).state;
            }
            if (target <= 2) return id(rdwc_lvl_2_sim).state;
            if (target == 3) return id(rdwc_lvl_3_sim).state;
            if (target == 4) return id(rdwc_lvl_4_sim).state;
            return id(rdwc_lvl_5_sim).state;
          };

          const bool main_lvl_reached = level_reached(main_target, true);
          const bool rdwc_lvl_reached = level_reached(rdwc_target, false);
          const bool rdwc_auto_lvl_reached = level_reached(rdwc_auto_target, false);
          const uint32_t now = millis();
          const uint32_t step_ms = 5000;

          const bool main_has_water = id(main_lvl_1).state || id(main_lvl_1_sim).state;

          auto get_sim_level = [&](bool is_main) -> int {
            if (is_main) {
              if (id(main_lvl_6_sim).state) return 6;
              if (id(main_lvl_5_sim).state) return 5;
              if (id(main_lvl_4_sim).state) return 4;
              if (id(main_lvl_3_sim).state) return 3;
              if (id(main_lvl_2_sim).state) return 2;
              if (id(main_lvl_1_sim).state) return 1;
              return 0;
            }
            if (id(rdwc_lvl_6_sim).state) return 6;
            if (id(rdwc_lvl_5_sim).state) return 5;
            if (id(rdwc_lvl_4_sim).state) return 4;
            if (id(rdwc_lvl_3_sim).state) return 3;
            if (id(rdwc_lvl_2_sim).state) return 2;
            if (id(rdwc_lvl_1_sim).state) return 1;
            return 0;
          };

          auto get_rdwc_level = [&]() -> int {
            if (id(rdwc_lvl_6).state || id(rdwc_lvl_6_sim).state) return 6;
            if (id(rdwc_lvl_5).state || id(rdwc_lvl_5_sim).state) return 5;
            if (id(rdwc_lvl_4).state || id(rdwc_lvl_4_sim).state) return 4;
            if (id(rdwc_lvl_3).state || id(rdwc_lvl_3_sim).state) return 3;
            if (id(rdwc_lvl_2).state || id(rdwc_lvl_2_sim).state) return 2;
            if (id(rdwc_lvl_1).state || id(rdwc_lvl_1_sim).state) return 1;
            return 0;
          };

          auto set_sim_level = [&](int level, bool is_main) {
            if (level < 1) return;
            if (is_main) {
              if (level >= 1) id(main_lvl_1_sim).turn_on();
              if (level >= 2) id(main_lvl_2_sim).turn_on();
              if (level >= 3) id(main_lvl_3_sim).turn_on();
              if (level >= 4) id(main_lvl_4_sim).turn_on();
              if (level >= 5) id(main_lvl_5_sim).turn_on();
              if (level >= 6) id(main_lvl_6_sim).turn_on();
            } else {
              if (level >= 1) id(rdwc_lvl_1_sim).turn_on();
              if (level >= 2) id(rdwc_lvl_2_sim).turn_on();
              if (level >= 3) id(rdwc_lvl_3_sim).turn_on();
              if (level >= 4) id(rdwc_lvl_4_sim).turn_on();
              if (level >= 5) id(rdwc_lvl_5_sim).turn_on();
              if (level >= 6) id(rdwc_lvl_6_sim).turn_on();
            }
          };

          if (id(automation_phase) == 0) {
            if (id(main_fill_relay).state) {
              if (id(befuell_main_sim_last_ms) == 0) id(befuell_main_sim_last_ms) = now;
              if (now - id(befuell_main_sim_last_ms) >= step_ms) {
                int current = get_sim_level(true);
                int next = current + 1;
                if (next <= 6) {
                  set_sim_level(next, true);
                }
                id(befuell_main_sim_last_ms) = now;
              }
            } else {
              id(befuell_main_sim_last_ms) = 0;
            }
            if (id(rdwc_fill_relay).state) {
              if (id(befuell_rdwc_sim_last_ms) == 0) id(befuell_rdwc_sim_last_ms) = now;
              if (now - id(befuell_rdwc_sim_last_ms) >= step_ms) {
                int current = get_sim_level(false);
                int next = current + 1;
                if (next <= 6) {
                  set_sim_level(next, false);
                }
                id(befuell_rdwc_sim_last_ms) = now;
              }
            } else {
              id(befuell_rdwc_sim_last_ms) = 0;
            }
          }

          if (id(automation_phase) == 0) {
            if (id(rdwc_auto_fill_enabled).state) {
              // TODO: Add debounce/lockout for "water draw" so auto-fill waits until
              // RDWC level is below target for X minutes and possibly until next level
              // is crossed before refilling.
              int start_threshold = rdwc_auto_target - 2;
              if (start_threshold < 1) start_threshold = 1;
              int current_level = get_rdwc_level();
              if (rdwc_auto_lvl_reached) {
                if (id(rdwc_auto_active_filling)) {
                  id(rdwc_auto_done_ms) = now;
                  id(rdwc_auto_active_filling) = false;
                  auto now_time = id(ha_time).now();
                  if (now_time.is_valid()) {
                    id(rdwc_auto_last_fill_ts) = now_time.timestamp;
                  }
                }
                if (id(rdwc_fill_relay).state) {
                  id(rdwc_fill_relay).turn_off();
                }
                return;
              }
              if (!main_has_water) {
                if (id(rdwc_fill_relay).state) {
                  id(rdwc_fill_relay).turn_off();
                }
                id(rdwc_auto_active_filling) = false;
                return;
              }
              if (id(rdwc_fill_relay).state) {
                id(rdwc_auto_active_filling) = true;
                return;
              }
              if (current_level <= start_threshold) {
                if (!id(rdwc_fill_relay).state) {
                  id(rdwc_fill_relay).turn_on();
                  id(rdwc_auto_active_filling) = true;
                }
              }
            } else {
              id(rdwc_auto_active_filling) = false;
            }
            return;
          }

          if (id(automation_phase) == 1) {
            if (id(rdwc_fill_relay).state) {
              id(rdwc_fill_relay).turn_off();
            }
            if (!main_lvl_reached) {
              if (!id(main_fill_relay).state) {
                id(main_fill_relay).turn_on();
              }
              int current = get_sim_level(true);
              if (id(befuell_main_sim_level) < current) {
                id(befuell_main_sim_level) = current;
              }
              if (id(main_fill_relay).state) {
                if (id(befuell_main_sim_last_ms) == 0) id(befuell_main_sim_last_ms) = now;
                if (now - id(befuell_main_sim_last_ms) >= step_ms) {
                  int next = id(befuell_main_sim_level) + 1;
                  if (next <= main_target) {
                    set_sim_level(next, true);
                    id(befuell_main_sim_level) = next;
                  }
                  id(befuell_main_sim_last_ms) = now;
                }
              }
            } else {
              id(main_fill_relay).turn_off();
              if (id(befuell_skip_wait)) {
                id(automation_phase) = 3;
                id(automation_wait_start_ms) = 0;
              } else {
                id(automation_phase) = 2;
                id(automation_wait_start_ms) = now;
              }
              id(befuell_rdwc_started) = false;
            }
            return;
          }

          if (id(automation_phase) == 2) {
            if (id(main_fill_relay).state) {
              id(main_fill_relay).turn_off();
            }
            if (id(rdwc_fill_relay).state) {
              id(rdwc_fill_relay).turn_off();
            }
            uint32_t wait_ms = (uint32_t)(id(befuell_automation_wait_seconds).state * 1000.0f);
            if (wait_ms == 0 || (now - id(automation_wait_start_ms)) >= wait_ms) {
              id(automation_phase) = 3;
              id(befuell_rdwc_started) = false;
            }
            return;
          }

          if (id(automation_phase) == 3) {
            if (id(main_fill_relay).state) {
              id(main_fill_relay).turn_off();
            }
            if (!id(befuell_rdwc_started)) {
              id(befuell_rdwc_started) = true;
            }
            if (!rdwc_lvl_reached) {
              if (!id(rdwc_fill_relay).state) {
                id(rdwc_fill_relay).turn_on();
              }
              int current = get_sim_level(false);
              if (id(befuell_rdwc_sim_level) < current) {
                id(befuell_rdwc_sim_level) = current;
              }
              if (id(rdwc_fill_relay).state) {
                if (id(befuell_rdwc_sim_last_ms) == 0) id(befuell_rdwc_sim_last_ms) = now;
                if (now - id(befuell_rdwc_sim_last_ms) >= step_ms) {
                  int next = id(befuell_rdwc_sim_level) + 1;
                  if (next <= rdwc_target) {
                    set_sim_level(next, false);
                    id(befuell_rdwc_sim_level) = next;
                  }
                  id(befuell_rdwc_sim_last_ms) = now;
                }
              }
            } else {
              if (id(rdwc_fill_relay).state) {
                id(rdwc_fill_relay).turn_off();
              }
              id(automation_phase) = 0;
              id(automation_wait_start_ms) = 0;
              id(befuell_rdwc_started) = false;
              id(befuell_main_sim_last_ms) = 0;
              id(befuell_rdwc_sim_last_ms) = 0;
              if (id(rdwc_lvl_4_sim).state) {
                id(befuell_last_result) = 1;
                id(befuell_done_ms) = now;
              }
            }
          }

sensor:
  - platform: wifi_signal
    name: "Tankknoten WiFi Signal"
    unit_of_measurement: "dBm"
    state_class: measurement
    update_interval: 30s
    entity_category: diagnostic
  - platform: uptime
    name: "Tankknoten Uptime"
    unit_of_measurement: "h"
    state_class: total_increasing
    update_interval: 60s
    entity_category: diagnostic
  - platform: internal_temperature
    name: "Tankknoten ESP32 Temperatur"
    unit_of_measurement: "°C"
    state_class: measurement
    update_interval: 30s
    entity_category: diagnostic
  - platform: template
    name: "Tankknoten EC Roh"
    id: tank_ec_raw
    unit_of_measurement: "mS/cm"
    accuracy_decimals: 2
    state_class: measurement
    update_interval: 30s
    lambda: |-
      const float min_val = 0.8f;
      const float max_val = 2.6f;
      const float mid = (min_val + max_val) * 0.5f;
      const float amp = (max_val - min_val) * 0.5f;
      const uint32_t period_ms = 3600000UL;
      float phase = (float)(millis() % period_ms) / (float)period_ms;
      phase += 0.10f;
      if (phase > 1.0f) phase -= 1.0f;
      return mid + amp * sinf(phase * 2.0f * 3.1415926f);
  - platform: template
    name: "Tankknoten EC kompensiert"
    unit_of_measurement: "mS/cm"
    accuracy_decimals: 2
    state_class: measurement
    update_interval: 30s
    lambda: |-
      float ec_raw = id(tank_ec_raw).state;
      if (isnan(ec_raw)) return NAN;
      if (!id(ec_temp_comp_enabled).state) {
        return ec_raw;
      }
      float temp_c = id(tank_temp_raw).state;
      if (isnan(temp_c)) {
        return ec_raw;
      }
      float alpha = 0.02f;
      return ec_raw / (1.0f + alpha * (temp_c - 25.0f));
  - platform: template
    name: "Tankknoten EC"
    unit_of_measurement: "mS/cm"
    accuracy_decimals: 2
    state_class: measurement
    update_interval: 30s
    lambda: |-
      float ec_raw = id(tank_ec_raw).state;
      if (isnan(ec_raw)) return NAN;
      if (!id(ec_temp_comp_enabled).state) {
        return ec_raw;
      }
      float temp_c = id(tank_temp_raw).state;
      if (isnan(temp_c)) {
        return ec_raw;
      }
      return ec_raw / (1.0f + 0.02f * (temp_c - 25.0f));
  - platform: template
    name: "Tankknoten pH"
    unit_of_measurement: "pH"
    accuracy_decimals: 2
    state_class: measurement
    update_interval: 30s
    lambda: |-
      const float min_val = 5.4f;
      const float max_val = 6.5f;
      const float mid = (min_val + max_val) * 0.5f;
      const float amp = (max_val - min_val) * 0.5f;
      const uint32_t period_ms = 3600000UL;
      float phase = (float)(millis() % period_ms) / (float)period_ms;
      phase += 0.35f;
      if (phase > 1.0f) phase -= 1.0f;
      return mid + amp * sinf(phase * 2.0f * 3.1415926f);
  - platform: template
    name: "Tankknoten Wassertemperatur Roh"
    id: tank_temp_raw
    unit_of_measurement: "°C"
    accuracy_decimals: 1
    state_class: measurement
    update_interval: 30s
    lambda: |-
      const float min_val = 18.0f;
      const float max_val = 24.0f;
      const float mid = (min_val + max_val) * 0.5f;
      const float amp = (max_val - min_val) * 0.5f;
      const uint32_t period_ms = 3600000UL;
      float phase = (float)(millis() % period_ms) / (float)period_ms;
      phase += 0.60f;
      if (phase > 1.0f) phase -= 1.0f;
      return mid + amp * sinf(phase * 2.0f * 3.1415926f);
  - platform: template
    name: "Tankknoten Wassertemperatur"
    unit_of_measurement: "°C"
    accuracy_decimals: 1
    state_class: measurement
    update_interval: 30s
    lambda: |-
      float raw = id(tank_temp_raw).state;
      if (isnan(raw)) return NAN;
      return raw + id(tank_temp_offset).state;
  - platform: template
    name: "Haupttank Fuellstand"
    id: main_tank_level_l
    unit_of_measurement: "L"
    accuracy_decimals: 1
    lambda: |-
      float pct = id(main_tank_level_pct).state;
      if (id(main_tank_volume_l).state <= 0.0f) return 0.0f;
      return id(main_tank_volume_l).state * (pct / 100.0f);
    update_interval: 5s

  - platform: template
    name: "Haupttank Fuellstand Prozent"
    id: main_tank_level_pct
    unit_of_measurement: "%"
    accuracy_decimals: 1
    lambda: |-
      if (id(main_lvl_6).state) return 100.0f;
      if (id(main_lvl_5).state) return 83.3f;
      if (id(main_lvl_4).state) return 66.6f;
      if (id(main_lvl_3).state) return 50.0f;
      if (id(main_lvl_2).state) return 33.3f;
      if (id(main_lvl_1).state) return 16.6f;
      return 0.0f;
    update_interval: 5s

  - platform: template
    name: "RDWC Fuellstand"
    id: rdwc_tank_level_l
    unit_of_measurement: "L"
    accuracy_decimals: 1
    lambda: |-
      float pct = id(rdwc_tank_level_pct).state;
      if (id(rdwc_tank_volume_l).state <= 0.0f) return 0.0f;
      return id(rdwc_tank_volume_l).state * (pct / 100.0f);
    update_interval: 5s

  - platform: template
    name: "RDWC Fuellstand Prozent"
    id: rdwc_tank_level_pct
    unit_of_measurement: "%"
    accuracy_decimals: 1
    lambda: |-
      if (id(rdwc_lvl_6).state) return 100.0f;
      if (id(rdwc_lvl_5).state) return 83.3f;
      if (id(rdwc_lvl_4).state) return 66.6f;
      if (id(rdwc_lvl_3).state) return 50.0f;
      if (id(rdwc_lvl_2).state) return 33.3f;
      if (id(rdwc_lvl_1).state) return 16.6f;
      return 0.0f;
    update_interval: 5s

  - platform: template
    name: "Haupttank Status"
    id: main_tank_state
    lambda: |-
      float pct = id(main_tank_level_pct).state;
      if (pct <= 5.0f) return 0;
      if (pct <= 40.0f) return 1;
      if (pct >= 90.0f) return 3;
      return 2;
    update_interval: 30s
    accuracy_decimals: 0

  - platform: template
    name: "RDWC Status"
    id: rdwc_tank_state
    lambda: |-
      float pct = id(rdwc_tank_level_pct).state;
      if (pct <= 5.0f) return 0;
      if (pct <= 40.0f) return 1;
      if (pct >= 90.0f) return 3;
      return 2;
    update_interval: 30s
    accuracy_decimals: 0
  - platform: template
    name: "Haupttank Zuletzt Voll"
    device_class: timestamp
    update_interval: 60s
    lambda: |-
      if (id(main_last_full_ts) == 0) return NAN;
      return (float) id(main_last_full_ts);
  - platform: template
    name: "Haupttank Zuletzt Leer"
    device_class: timestamp
    update_interval: 60s
    lambda: |-
      if (id(main_last_low_ts) == 0) return NAN;
      return (float) id(main_last_low_ts);
  - platform: template
    name: "RDWC Zuletzt Voll"
    device_class: timestamp
    update_interval: 60s
    lambda: |-
      if (id(rdwc_last_full_ts) == 0) return NAN;
      return (float) id(rdwc_last_full_ts);
  - platform: template
    name: "RDWC Zuletzt Leer"
    device_class: timestamp
    update_interval: 60s
    lambda: |-
      if (id(rdwc_last_low_ts) == 0) return NAN;
      return (float) id(rdwc_last_low_ts);
  - platform: template
    name: "RDWC Auto Zuletzt Befuellt (TS)"
    device_class: timestamp
    update_interval: 60s
    lambda: |-
      if (id(rdwc_auto_last_fill_ts) == 0) return NAN;
      return (float) id(rdwc_auto_last_fill_ts);

text_sensor:
  - platform: template
    name: "Geraetename"
    id: tankknoten_device_name
    icon: "mdi:identifier"
    entity_category: diagnostic
    lambda: |-
      return {"tankknoten"};
    update_interval: 3600s
  - platform: wifi_info
    ip_address:
      name: "Tankknoten IP"
      entity_category: diagnostic
    ssid:
      name: "Tankknoten WLAN SSID"
      entity_category: diagnostic
    bssid:
      name: "Tankknoten WLAN BSSID"
      entity_category: diagnostic
    mac_address:
      name: "Tankknoten MAC"
      entity_category: diagnostic
  - platform: template
    name: "Tankknoten Version"
    entity_category: diagnostic
    lambda: |-
      return {"v1.4"};
    update_interval: 3600s
  - platform: template
    name: "Tankregelung RDWC Version"
    entity_category: diagnostic
    lambda: |-
      return {"v0.4"};
    update_interval: 3600s
  - platform: template
    name: "Tankregelung Haupttank Version"
    entity_category: diagnostic
    lambda: |-
      return {"v0.4"};
    update_interval: 3600s
  - platform: template
    name: "Befuellautomatik System Ergebnis"
    entity_category: diagnostic
    lambda: |-
      const uint32_t now = millis();
      if (id(automation_phase) == 0) {
        if (id(befuell_done_ms) != 0 && (now - id(befuell_done_ms)) < 60000UL) {
          return {"Beendet (befuellt)"};
        }
        return {"Aus"};
      }
      if (id(main_fill_relay).state || id(rdwc_fill_relay).state) {
        return {"Laeuft"};
      }
      return {"Ein"};
    update_interval: 5s
  - platform: template
    name: "Befuellautomatik System Version"
    entity_category: diagnostic
    lambda: |-
      return {"v0.2"};
    update_interval: 3600s
  - platform: template
    name: "RDWC Automatik Version"
    entity_category: diagnostic
    lambda: |-
      return {"v0.2"};
    update_interval: 3600s
  - platform: template
    name: "RDWC Auto Status"
    entity_category: diagnostic
    lambda: |-
      const uint32_t now = millis();
      if (!id(rdwc_auto_fill_enabled).state) {
        return {"Aus"};
      }
      if (id(rdwc_fill_relay).state) {
        return {"Laeuft"};
      }
      if (id(rdwc_auto_done_ms) != 0 && (now - id(rdwc_auto_done_ms)) < 60000UL) {
        return {"Beendet"};
      }
      return {"Ein"};
    update_interval: 5s
  - platform: template
    name: "RDWC Auto Zuletzt Befuellt"
    entity_category: diagnostic
    lambda: |-
      auto now_time = id(ha_time).now();
      if (!now_time.is_valid()) return {"Keine Zeit"};
      if (id(rdwc_auto_last_fill_ts) == 0) return {"Nie"};
      uint32_t now_ts = now_time.timestamp;
      if (now_ts <= id(rdwc_auto_last_fill_ts)) return {"Gerade"};
      uint32_t diff_s = now_ts - id(rdwc_auto_last_fill_ts);
      uint32_t diff_min = diff_s / 60;
      if (diff_min < 1) return {"Gerade"};
      if (diff_min < 60) {
        char buffer[24];
        snprintf(buffer, sizeof(buffer), "vor %u min", diff_min);
        return {buffer};
      }
      uint32_t diff_h = diff_min / 60;
      char buffer[24];
      snprintf(buffer, sizeof(buffer), "vor %u Std", diff_h);
      return {buffer};
    update_interval: 60s
